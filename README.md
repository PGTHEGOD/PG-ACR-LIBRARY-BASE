# ระบบบริหารห้องสมุดสำหรับครู (Library-BASE)
พัฒนาและดูแลโดย **Akarapach Yootsukprasert (Park AKA PG Dev.) – นักเรียนชั้น ม.6 โรงเรียนอัสสัมชัญระยอง ปีการศึกษา 2025** เพื่อแก้ปัญหางานเอกสารที่ยุ่งยากของครูห้องสมุด โดยเชื่อมระบบใหม่เข้ากับฐานข้อมูลเดิมที่โรงเรียนใช้อยู่ พร้อมปรับ UI ให้ใช้งานง่ายและรองรับการสแกนบาร์โค้ดจริง

---

## ภาพรวมโครงการ
- ใช้ธีมและประสบการณ์ใช้งานแบบเดียวกับ “ระบบลงทะเบียนเข้าใช้ห้องสมุด” แต่เพิ่มฟังก์ชันเฉพาะสำหรับครู/บรรณารักษ์
- รองรับการเชื่อมต่อฐานข้อมูล MySQL จริง (ใช้ตาราง `students`, `library_books`, `library_loans`, `library_scores`)
- แยกเวอร์ชัน “Sheet” และ “MySQL” เป็น Default เพื่อให้ Deploy ได้ทั้งบนเครื่องครูและเซิร์ฟเวอร์โรงเรียน
- มี Dockerfile + Instructions สำหรับ Deploy บนเครื่องแม่ข่าย หรือระบบ Cloud ภายในโรงเรียน

---

## ฟีเจอร์เด่น
| โมดูล | รายละเอียด |
| --- | --- |
| **Device Access Lock** | ครูแต่ละเครื่องต้องยืนยันรหัส (`LIBRARY_ACCESS_CODE`) ป้องกันการใช้งานจากอุปกรณ์ภายนอก |
| **Student Management** | ดูโปรไฟล์, ค้นหา, นำเข้า JSON, จัดเก็บคะแนนและห้องเรียนครบตามตาราง `students` |
| **Borrow / Return** | รองรับการสแกนบาร์โค้ดหรือกรอกรหัสอัสสัม 6 หลัก พร้อมเตือนหากหนังสือถูกยืมอยู่ หรือเกินโควตา (2 เล่ม) |
| **Auto Points** | เมื่อคืนสำเร็จ ระบบบันทึกคะแนน “ความมีระเบียบ +5” อัตโนมัติและแสดงในประวัติ |
| **Book Management** | เพิ่ม/แก้ไข/ลบเล่ม, อัปโหลดรูปปก, ดูสถานะ, ส่งออก Excel, นำเข้า JSON/Worksheet จำนวนมากได้ (Batch Batching) |
| **Quick Add** | เมื่อสแกนไม่เจอเล่ม ระบบให้เพิ่มข้อมูลได้ทันที พร้อมดึงข้อมูลจากฐานเดิมหรือ Open Library ช่วยกรอก |
| **API เต็มระบบ** | `/api/library/*` ใช้งานจริงกับ MySQL และรองรับการเรียกจากระบบขยายในอนาคต |
| **Library Print System** | สร้าง QR รับไฟล์หลายไฟล์ผ่านเซิร์ฟเวอร์ (PDF / DOCX / รูปภาพ) จัดเก็บชั่วคราวและเปิด Print Preview / Download บนเครื่องครูได้ทันที |

---

## โครงสร้างโฟลเดอร์สำคัญ
```
app/                      หน้าจอหลัก (Teacher Portal + Books + Students)
lib/server                Logic ฝั่งเซิร์ฟเวอร์ (บริการ MySQL)
app/api/*                API Routes (Next.js App Router)
public/uploads           ที่เก็บรูปปกเมื่ออัปโหลดผ่านระบบ
Dockerfile               ใช้ build / deploy แบบ container
```

---

## วิธีเริ่มต้นใช้งาน (Dev)
```bash
pnpm install
pnpm dev
```
เปิด `http://localhost:3000` แล้วกรอกรหัสอุปกรณ์ (`LIBRARY_ACCESS_CODE`) ตามที่ตั้งใน `.env.local`

---

## Library Print System
- เปิด `http://localhost:3000/print` บนเครื่องพิมพ์ → ไม่ต้องกรอกรหัสอุปกรณ์เพิ่มเติม แค่กดสร้าง QR แล้วรอสแกน
- นักเรียนสามารถเลือกหลายไฟล์ (PDF/DOCX/รูปภาพ ฯลฯ) ต่อการส่งแต่ละครั้งได้เลย ระบบจะส่งเข้าเซิร์ฟเวอร์ของ Library-BASE
- หน้าครูจะแสดงรายการไฟล์ทั้งหมดพร้อมปุ่ม **Print Preview**, **Download เอกสารเดี่ยว** และ **Download ZIP ทั้งหมด** เพื่อความสะดวก
- QR และไฟล์จะถูกลบทันทีเมื่อปิดหน้าจอหรือกด “ปิดการเชื่อมต่อ” (หรือเมื่อ QR หมดอายุ 10 นาที)

## ตัวแปรสภาพแวดล้อมที่ใช้
| ตัวแปร | คำอธิบาย |
| --- | --- |
| `LIBRARY_ACCESS_CODE` | รหัสที่ครูใช้ปลดล็อกอุปกรณ์ |
| `LIBRARY_ACCESS_SESSION_TOKEN` | คุกกี้ session ระหว่างใช้งาน |
| `MYSQL_HOST / PORT / USER / PASSWORD / DATABASE` | การเชื่อม MySQL จริง (ค่า default เป็น `pgdev/parkggez`) |
| `COVER_UPLOAD_DIR` | โฟลเดอร์ที่เก็บไฟล์รูปปก (default `public/uploads`) |
| `NEXT_PUBLIC_COVER_BASE_URL` | URL สำหรับอ้างถึงรูปปก เช่น `/uploads` หรือ `https://library.acr.ac.th/uploads` |

> *สามารถตั้งค่า `.env.local` ตามตัวอย่าง `env.example` ที่อยู่ในโปรเจกต์ได้เลย*

---

## การนำเข้า/ส่งออกข้อมูลจำนวนมาก
### นำเข้า JSON / Worksheet
- เปิดเมนู “นำเข้า JSON” → เลือกไฟล์ หรือวาง JSON ลงใน Textarea
- ระบบรองรับไฟล์ใหญ่ (2,900+ รายการ) โดยประมวลผลแบบ Chunk และรายงานจำนวนที่ **ซ้ำ / ข้าม / บันทึกสำเร็จ** กลับมาให้ดู
- หากมีข้อมูลในระบบแต่ไม่อยู่ในไฟล์ สามารถเลือก “ลบหนังสือที่ไม่มีในไฟล์” เพื่อซิงก์ให้ตรงกันได้

### ส่งออก Excel
กด “ส่งออก Excel” → จะได้ไฟล์ `.xlsx` ครบทุกคอลัมน์ (รหัสอัสสัม, เล่ม, ภาษา, ผู้ยืม, กำหนดคืน ฯลฯ)

---

## Docker Deployment (Production)
```bash
# ขั้นตอนแนะนำ
pnpm install
pnpm build
docker build -t acr-library-base .
docker run -d -p 3000:3000 --env-file .env.production acr-library-base
```
> Container ใช้ `pnpm start` และเปิดพอร์ต 3000 โดยอัตโนมัติ

---

## จุดเด่นเชิงเทคนิค
- Next.js 16 + App Router + React 19 (ใช้ Client/Server Components อย่างเหมาะสม)
- MySQL ผ่าน `mysql2/promise` และ Seeding schema อัตโนมัติใน `lib/db.ts`
- การนำเข้าไฟล์ใหญ่ใช้ **Batch Insert + Chunk 200 รายการ** เพื่อความเร็วและความเสถียร
- รองรับการอัปโหลดรูปปกพร้อมบันทึก URL (เชื่อมกับโฟลเดอร์ภายในหรือ CDN ได้)
- มีระบบล็อกการยืม (Borrow Lock) เพื่อจำกัดให้ผู้เรียนยืมเพียง 2 เล่มต่อรอบ และต้องคืนให้ครบก่อนเริ่มรอบใหม่

---

## เครดิตและการใช้งาน
โค้ดทั้งหมดพัฒนาโดย **Akarapach Yootsukprasert (Park AKA PG Dev.) – นักเรียนชั้น ม.6 โรงเรียนอัสสัมชัญระยอง ปีการศึกษา 2025**  
อนุญาตให้ใช้งาน/พัฒนาต่อยอดได้ภายในโรงเรียนหรือเพื่อการศึกษา **แต่กรุณารักษาเครดิตเต็มรูปแบบตามข้อความด้านบน**



> *ขอบคุณครูและเพื่อน ๆ ที่ช่วยทดสอบระบบ หากมีข้อเสนอแนะเพิ่มเติมสามารถแจ้งโดยตรง เราพร้อมพัฒนาให้ห้องสมุดใช้งานจริงได้เต็มประสิทธิภาพ*


## การเก็บรูปปกเมื่อใช้ Docker
หากรันผ่าน Docker container แนะนำให้ map โฟลเดอร์ `public/uploads` ออกมาเป็น volume เพื่อให้ภาพที่อัปโหลดยังอยู่แม้จะ restart หรือ deploy ใหม่ เช่น

```bash
docker run \
  -d -p 3000:3000 \
  -v $(pwd)/uploads-data:/app/public/uploads \
  --env-file .env.production \
  acr-library-base
```
```
- `uploads-data` คือโฟลเดอร์บนเครื่องจริงที่เราต้องการเก็บรูปถาวร
- ภาพทั้งหมดจะถูกเสิร์ฟผ่าน `/uploads/...` ตามค่า `NEXT_PUBLIC_COVER_BASE_URL`
```
